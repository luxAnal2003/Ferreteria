/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/GUIForms/JPanel.java to edit this template
 */
package vista;

import controlador.CategoriaController;
import controlador.ProductoController;
import controlador.ProveedorController;
import javax.swing.JOptionPane;
import javax.swing.table.DefaultTableModel;
import modelo.Categoria;
import java.util.List;
import javax.swing.JComboBox;
import modelo.Producto;
import modelo.Proveedor;

/**
 *
 * @author admin
 */
public class JPanelProductoNuevo extends javax.swing.JPanel {

    /**
     * Creates new form JPanelCategoriaNuevo
     */
    public JPanelProductoNuevo() {
        initComponents();

        CategoriaController categoriaController = new CategoriaController();
        List<Categoria> listaCategorias = categoriaController.listarCategorias();
        cargarEnComboBox(cboxCategoria, listaCategorias);

        ProveedorController proveedorController = new ProveedorController();
        List<Proveedor> listaProveedores = proveedorController.listarProveedores();
        cargarEnComboBox(cboxProveedor, listaProveedores);

        cargarProductosEnTabla();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        btnLimpiar = new javax.swing.JButton();
        btnGuardar = new javax.swing.JButton();
        jLabel2 = new javax.swing.JLabel();
        jLabel5 = new javax.swing.JLabel();
        jLabel6 = new javax.swing.JLabel();
        txtNombreProducto = new javax.swing.JTextField();
        jLabel9 = new javax.swing.JLabel();
        jLabel10 = new javax.swing.JLabel();
        jLabel11 = new javax.swing.JLabel();
        cboxProveedor = new javax.swing.JComboBox<>();
        txtStock = new javax.swing.JTextField();
        txtPrecio = new javax.swing.JTextField();
        jScrollPane2 = new javax.swing.JScrollPane();
        textAreaDescripcion = new javax.swing.JTextArea();
        jLabel7 = new javax.swing.JLabel();
        cboxCategoria = new javax.swing.JComboBox<>();
        jScrollPane3 = new javax.swing.JScrollPane();
        tableProducto = new javax.swing.JTable();

        setBackground(new java.awt.Color(255, 255, 255));
        setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        btnLimpiar.setBackground(new java.awt.Color(204, 204, 255));
        btnLimpiar.setFont(new java.awt.Font("Tahoma", 1, 14)); // NOI18N
        btnLimpiar.setText("Limpiar");
        btnLimpiar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnLimpiarActionPerformed(evt);
            }
        });
        add(btnLimpiar, new org.netbeans.lib.awtextra.AbsoluteConstraints(680, 330, 100, 30));

        btnGuardar.setBackground(new java.awt.Color(204, 204, 255));
        btnGuardar.setFont(new java.awt.Font("Tahoma", 1, 14)); // NOI18N
        btnGuardar.setText("Guardar");
        btnGuardar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnGuardarActionPerformed(evt);
            }
        });
        add(btnGuardar, new org.netbeans.lib.awtextra.AbsoluteConstraints(550, 330, 110, 30));

        jLabel2.setFont(new java.awt.Font("Tahoma", 1, 18)); // NOI18N
        jLabel2.setText("Nuevo Producto");
        add(jLabel2, new org.netbeans.lib.awtextra.AbsoluteConstraints(380, 30, -1, -1));

        jLabel5.setFont(new java.awt.Font("Tahoma", 1, 14)); // NOI18N
        jLabel5.setText("Nombre del producto:");
        add(jLabel5, new org.netbeans.lib.awtextra.AbsoluteConstraints(470, 80, -1, -1));

        jLabel6.setFont(new java.awt.Font("Tahoma", 1, 14)); // NOI18N
        jLabel6.setText("Categoria:");
        add(jLabel6, new org.netbeans.lib.awtextra.AbsoluteConstraints(470, 130, -1, -1));
        add(txtNombreProducto, new org.netbeans.lib.awtextra.AbsoluteConstraints(470, 100, 190, -1));

        jLabel9.setFont(new java.awt.Font("Tahoma", 1, 14)); // NOI18N
        jLabel9.setText("Precio:");
        add(jLabel9, new org.netbeans.lib.awtextra.AbsoluteConstraints(470, 180, -1, -1));

        jLabel10.setFont(new java.awt.Font("Tahoma", 1, 14)); // NOI18N
        jLabel10.setText("Cantidad en stock:");
        add(jLabel10, new org.netbeans.lib.awtextra.AbsoluteConstraints(680, 180, -1, -1));

        jLabel11.setFont(new java.awt.Font("Tahoma", 1, 14)); // NOI18N
        jLabel11.setText("Descripción:");
        add(jLabel11, new org.netbeans.lib.awtextra.AbsoluteConstraints(470, 230, -1, -1));

        cboxProveedor.setModel(new javax.swing.DefaultComboBoxModel<>(new String[] { "Item 1", "Item 2", "Item 3", "Item 4" }));
        add(cboxProveedor, new org.netbeans.lib.awtextra.AbsoluteConstraints(680, 100, 190, -1));
        add(txtStock, new org.netbeans.lib.awtextra.AbsoluteConstraints(680, 200, 190, -1));
        add(txtPrecio, new org.netbeans.lib.awtextra.AbsoluteConstraints(470, 200, 190, -1));

        textAreaDescripcion.setColumns(20);
        textAreaDescripcion.setRows(5);
        jScrollPane2.setViewportView(textAreaDescripcion);

        add(jScrollPane2, new org.netbeans.lib.awtextra.AbsoluteConstraints(470, 250, 400, 70));

        jLabel7.setFont(new java.awt.Font("Tahoma", 1, 14)); // NOI18N
        jLabel7.setText("Proveedor:");
        add(jLabel7, new org.netbeans.lib.awtextra.AbsoluteConstraints(680, 80, -1, -1));

        cboxCategoria.setModel(new javax.swing.DefaultComboBoxModel<>(new String[] { "Item 1", "Item 2", "Item 3", "Item 4" }));
        add(cboxCategoria, new org.netbeans.lib.awtextra.AbsoluteConstraints(470, 150, 400, -1));

        jScrollPane3.setPreferredSize(new java.awt.Dimension(450, 80));

        tableProducto.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null, null, null},
                {null, null, null, null, null, null},
                {null, null, null, null, null, null},
                {null, null, null, null, null, null}
            },
            new String [] {
                "Producto", "Proveedor", "Categoría", "Precio", "Stock", "Estado"
            }
        ));
        tableProducto.setPreferredSize(new java.awt.Dimension(450, 80));
        jScrollPane3.setViewportView(tableProducto);

        add(jScrollPane3, new org.netbeans.lib.awtextra.AbsoluteConstraints(30, 80, 410, 280));
    }// </editor-fold>//GEN-END:initComponents

    private void btnGuardarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnGuardarActionPerformed
        Producto producto = new Producto();
        ProductoController controladorProducto = new ProductoController();

        // Validaciones de campos obligatorios
        if (txtNombreProducto.getText().isEmpty()
                || textAreaDescripcion.getText().isEmpty()
                || txtStock.getText().isEmpty()
                || txtPrecio.getText().isEmpty()
                || cboxProveedor.getSelectedItem() == null
                || cboxCategoria.getSelectedItem() == null
                || cboxProveedor.getSelectedIndex() == 0
                || cboxCategoria.getSelectedIndex() == 0) {

            JOptionPane.showMessageDialog(null, "Complete todos los campos");
            return;
        }

        // Validar existencia del producto
        String nombreIngresado = txtNombreProducto.getText().trim();
        if (controladorProducto.existeProducto(nombreIngresado)) {
            JOptionPane.showMessageDialog(null, "El producto ya existe");
            return;
        }

        // Formatear nombre
        String nombreFormateado = nombreIngresado.substring(0, 1).toUpperCase() + nombreIngresado.substring(1).toLowerCase();
        producto.setNombreProducto(nombreFormateado);

        // Establecer valores
        producto.setDescripcion(textAreaDescripcion.getText().trim());

        try {
            producto.setCantidad(Integer.parseInt(txtStock.getText().trim()));
            producto.setPrecio(Double.parseDouble(txtPrecio.getText().trim()));
        } catch (NumberFormatException e) {
            JOptionPane.showMessageDialog(null, "Cantidad o precio no válidos");
            return;
        }

        // IVA fijo
        producto.setIva(12.0);

        // Proveedor seleccionado
        Proveedor proveedorSeleccionado = (Proveedor) cboxProveedor.getSelectedItem();
        producto.setIdProveedor(proveedorSeleccionado);

        // Categoría seleccionada
        Categoria categoriaSeleccionada = (Categoria) cboxCategoria.getSelectedItem();
        producto.setIdCategoria(categoriaSeleccionada);

        // Estado activo
        producto.setEstado(1);

        // Guardar producto
        if (controladorProducto.guardar(producto)) {
            JOptionPane.showMessageDialog(null, "Producto registrado correctamente");
            cargarProductosEnTabla();
        } else {
            JOptionPane.showMessageDialog(null, "Error al guardar el producto");
        }

        this.setear(); // Limpiar campos
    }//GEN-LAST:event_btnGuardarActionPerformed

    private void btnLimpiarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnLimpiarActionPerformed
        this.setear();
    }//GEN-LAST:event_btnLimpiarActionPerformed

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnGuardar;
    private javax.swing.JButton btnLimpiar;
    private javax.swing.JComboBox<String> cboxCategoria;
    private javax.swing.JComboBox<String> cboxProveedor;
    private javax.swing.JLabel jLabel10;
    private javax.swing.JLabel jLabel11;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel5;
    private javax.swing.JLabel jLabel6;
    private javax.swing.JLabel jLabel7;
    private javax.swing.JLabel jLabel9;
    private javax.swing.JScrollPane jScrollPane2;
    private javax.swing.JScrollPane jScrollPane3;
    private javax.swing.JTable tableProducto;
    private javax.swing.JTextArea textAreaDescripcion;
    private javax.swing.JTextField txtNombreProducto;
    private javax.swing.JTextField txtPrecio;
    private javax.swing.JTextField txtStock;
    // End of variables declaration//GEN-END:variables

    private void cargarEnComboBox(JComboBox combo, List<?> lista) {
        combo.removeAllItems();
        combo.addItem("Seleccione una opción");

        for (Object obj : lista) {
            if (obj instanceof Categoria categoria) {
                if (categoria.getEstado() == 1) {
                    combo.addItem(categoria);
                }
            } else if (obj instanceof Proveedor proveedor) {
                if (proveedor.getEstado() == 1) {
                    combo.addItem(proveedor);
                }
            }
        }
    }

    private void cargarProductosEnTabla() {
        ProductoController controller = new ProductoController();
        List<Producto> lista = controller.listarProductos();

        DefaultTableModel modelo = new DefaultTableModel();
        modelo.addColumn("Producto");
        modelo.addColumn("Proveedor");
        modelo.addColumn("Categoría");
        modelo.addColumn("Precio");
        modelo.addColumn("Stock");
        modelo.addColumn("Descripción");
        modelo.addColumn("Estado");

        for (Producto p : lista) {
            String estadoTexto = p.getEstado() == 1 ? "Activo" : "Inactivo";
            
            modelo.addRow(new Object[]{
                p.getNombreProducto(),
                p.getIdProveedor().getNombre(),
                p.getIdCategoria().getNombre(),
                p.getPrecio(),
                p.getCantidad(),
                p.getDescripcion(),
                estadoTexto
            });
        }

        tableProducto.setModel(modelo);
    }

    private void setear() {
        txtNombreProducto.setText("");
        cboxProveedor.setSelectedIndex(0);
        cboxCategoria.setSelectedIndex(0);
        txtPrecio.setText("");
        txtStock.setText("");
        textAreaDescripcion.setText("");
    }
}
